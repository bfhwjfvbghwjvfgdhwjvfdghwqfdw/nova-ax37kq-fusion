# Auto-Update System Documentation

## Overview

Xvser now includes a fully-functional auto-update system that checks for updates on startup and provides a non-intrusive notification in the title bar.

## Features

### ✅ Automatic Update Checking
- Checks for updates 4 seconds after app startup
- Non-blocking and doesn't interfere with app usage
- Works only in packaged/production builds

### ✅ Visual Notification
- Small badge appears in the title bar (next to minimize/maximize/close buttons)
- Blue download icon with animated pulse when update is available
- Progress bar during download
- Green checkmark when ready to install

### ✅ User Control
- User decides when to download updates
- User decides when to install updates
- Can dismiss notifications and install later
- Update details shown in dropdown panel

### ✅ Update States

1. **Checking** - Spinning refresh icon while checking
2. **Available** - Blue download badge with version info
3. **Downloading** - Progress bar with percentage
4. **Downloaded** - Green checkmark, ready to install
5. **Error** - Red alert icon (auto-hides after 5s)

## How It Works

### For Users

1. **When update is available:**
   - A blue download icon appears in the title bar
   - Click it to see update details (version, release notes)
   - Click "Download" to start downloading
   - Click "Later" to dismiss

2. **When download completes:**
   - Icon changes to green checkmark
   - Click it to see install option
   - Click "Install & Restart" to install immediately
   - Click "Later" to install on next app quit

### For Developers

#### Publishing Updates

1. **Update version in package.json:**
   ```json
   {
     "version": "0.2.0"
   }
   ```

2. **Build the app:**
   ```bash
   npm run build
   npm run dist:win
   ```

3. **Create GitHub Release:**
   - Go to your repository on GitHub
   - Click "Releases" → "Create a new release"
   - Tag version: `v0.2.0` (must match package.json)
   - Upload the installer from `release/` folder:
     - `Xvser-Setup-0.2.0.exe`
     - `latest.yml` (auto-generated by electron-builder)
   - Add release notes
   - Publish release

4. **Users get notified:**
   - Next time users open the app, they'll see the update notification
   - They can download and install with one click

#### Configuration

The update system is configured in:

**electron-builder.json:**
```json
{
  "publish": {
    "provider": "github",
    "owner": "YOUR_GH_ORG_OR_USER",
    "repo": "xvser",
    "releaseType": "release"
  }
}
```

**Update this with your actual GitHub username/org and repo name!**

#### Update Channels

- **Stable:** Default, uses `latest.yml`
- **Beta:** Use `beta` channel in electron-builder config
- **Alpha:** Use `alpha` channel

#### Code Structure

**Main Process (electron/main.ts):**
- `autoUpdater` configuration
- Event handlers for update lifecycle
- IPC handlers for manual update checks

**Preload (electron/preload.ts):**
- Exposes update API to renderer
- Event listeners for update status

**Renderer (src/components/UpdateNotification.tsx):**
- UI component for update notifications
- State management for update flow
- User interaction handlers

**Title Bar (src/components/TitleBar.tsx):**
- Integrates UpdateNotification component
- Positioned between app name and window controls

## API Reference

### Main Process

```typescript
// Auto-check on startup (4s delay)
autoUpdater.checkForUpdates()

// Manual check
ipcMain.handle('update:check', async () => {...})

// Download update
ipcMain.handle('update:download', async () => {...})

// Install and restart
ipcMain.handle('update:install', () => {...})
```

### Renderer Process

```typescript
// Check for updates
await window.xvser.checkForUpdates()

// Download update
await window.xvser.downloadUpdate()

// Install update (will restart app)
await window.xvser.installUpdate()

// Listen for events
window.xvser.onUpdateAvailable((info) => {
  console.log('Update available:', info.version)
})

window.xvser.onUpdateDownloadProgress((progress) => {
  console.log('Download progress:', progress.percent)
})

window.xvser.onUpdateDownloaded((info) => {
  console.log('Update downloaded:', info.version)
})
```

## Testing

### Test in Development

The update system only works in packaged builds. To test:

1. Build and install version 0.1.0
2. Create a GitHub release with version 0.2.0
3. Open the installed app
4. Wait 4 seconds for update check
5. Update notification should appear

### Mock Testing

For development testing, you can temporarily modify `main.ts`:

```typescript
// Remove the app.isPackaged check temporarily
if (true) { // was: if (app.isPackaged)
  // ... update code
}
```

**Remember to revert this before committing!**

## Troubleshooting

### Updates not showing

1. **Check GitHub release:**
   - Is the release published (not draft)?
   - Is the tag format correct? (v0.2.0)
   - Is `latest.yml` uploaded?

2. **Check electron-builder.json:**
   - Is `owner` and `repo` correct?
   - Is `publish.provider` set to "github"?

3. **Check console logs:**
   - Open DevTools in dev mode
   - Look for `[updater]` logs

### Download fails

1. **Check internet connection**
2. **Check GitHub release assets are public**
3. **Check firewall/antivirus settings**

### Install fails

1. **Close all instances of the app**
2. **Run as administrator if needed**
3. **Check Windows SmartScreen settings**

## Security Notes

- Updates are downloaded over HTTPS
- Code signing verification is disabled (`verifyUpdateCodeSignature: false`)
  - For production, consider enabling code signing
  - Requires a valid code signing certificate
- Updates only work from the configured GitHub repository

## Future Enhancements

Possible improvements:

- [ ] Add update channels (stable/beta/alpha)
- [ ] Add "What's New" dialog with formatted release notes
- [ ] Add option to skip specific versions
- [ ] Add automatic update scheduling
- [ ] Add update size display before download
- [ ] Add rollback capability
- [ ] Add delta updates for faster downloads
- [ ] Add code signing for better security

## Related Files

- `electron/main.ts` - Update logic
- `electron/preload.ts` - IPC bridge
- `src/types/window.d.ts` - TypeScript types
- `src/components/UpdateNotification.tsx` - UI component
- `src/components/TitleBar.tsx` - Integration
- `electron-builder.json` - Build configuration
- `package.json` - Version number

## Support

For issues or questions:
1. Check the console logs for errors
2. Verify GitHub release configuration
3. Test with a fresh install
4. Check electron-updater documentation: https://www.electron.build/auto-update
