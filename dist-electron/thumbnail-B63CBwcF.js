"use strict";var E=Object.create;var $=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,M=Object.prototype.hasOwnProperty;var z=(a,e,t)=>e in a?$(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var I=(a,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of C(e))!M.call(a,r)&&r!==t&&$(a,r,{get:()=>e[r],enumerable:!(i=T(e,r))||i.enumerable});return a};var v=(a,e,t)=>(t=a!=null?E(j(a)):{},I(e||!a||!a.__esModule?$(t,"default",{value:a,enumerable:!0}):t,a));var l=(a,e,t)=>z(a,typeof e!="symbol"?e+"":e,t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("fs-extra"),c=require("path"),_=require("child_process"),P=require("util");let b,x;const K=P.promisify(_.exec),y=c.join(process.env.APPDATA||process.env.HOME||".",".xvser-cache");s.ensureDirSync(y);const q=new Set([".mp4",".mkv",".avi",".mov",".wmv",".flv",".webm",".m4v",".3gp"]),F=new Set([".jpg",".jpeg",".png",".gif",".bmp",".webp",".tiff",".svg"]);class O{constructor(){l(this,"queue",[]);l(this,"processing",0);l(this,"maxConcurrent",2);l(this,"cache",new Map);l(this,"maxCacheSize",500)}async add(e,t){const i=this.getCacheKey(e,t);if(this.cache.has(i))return this.cache.get(i);const r=new Promise((n,o)=>{this.queue.push({filePath:e,options:t,resolve:n,reject:o}),this.processQueue()});if(this.cache.size>=this.maxCacheSize){const n=this.cache.keys().next().value;this.cache.delete(n)}return this.cache.set(i,r),r}getCacheKey(e,t){const{width:i=256,height:r=256,quality:n=80,timestamp:o="00:00:01"}=t;return`${e}:${i}x${r}:${n}:${o}`}async processQueue(){if(this.processing>=this.maxConcurrent||this.queue.length===0)return;this.processing++;const e=this.queue.shift();try{const t=c.extname(e.filePath).toLowerCase();let i=null;F.has(t)?i=await D(e.filePath,e.options):q.has(t)&&(i=await N(e.filePath,e.options)),e.resolve(i)}catch(t){e.reject(t)}finally{this.processing--,this.queue.length>0&&this.processQueue()}}clearCache(){this.cache.clear()}getQueueSize(){return this.queue.length}}const A=new O;async function D(a,e={}){try{const{width:t=256,height:i=256,quality:r=80}=e,n=c.basename(a).replace(/[^a-z0-9]/gi,"_"),o=`img_${t}x${i}_${r}_${n}`,m=c.join(y,o+".webp");try{const[h,f]=await Promise.all([s.stat(m),s.stat(a)]);if(h.mtimeMs>f.mtimeMs)return`data:image/webp;base64,${(await s.readFile(m)).toString("base64")}`}catch{}const u=await b(a).resize(t,i,{fit:"contain",background:{r:0,g:0,b:0,alpha:0},withoutEnlargement:!0}).webp({quality:r,effort:0}).toBuffer({resolveWithObject:!1});return await s.writeFile(m,u),`data:image/webp;base64,${u.toString("base64")}`}catch(t){return console.error("Failed to generate image thumbnail:",t),null}}async function N(a,e={}){try{const{width:t=256,height:i=256,quality:r=80,timestamp:n="00:00:01"}=e,o=c.basename(a).replace(/[^a-z0-9]/gi,"_"),m=`vid_${t}x${i}_${r}_${n}_${o}`,u=c.join(y,m+".webp");try{const[p,g]=await Promise.all([s.stat(u),s.stat(a)]);if(p.mtimeMs>g.mtimeMs)return`data:image/webp;base64,${(await s.readFile(u)).toString("base64")}`}catch{}const h=c.join(y,`temp_${Date.now()}_${Math.random().toString(36).slice(2)}.jpg`);if(await new Promise((p,g)=>{const w=_.spawn("ffmpeg",["-ss",n,"-i",a,"-vframes","1","-vf",`scale=${t}:${i}:force_original_aspect_ratio=decrease`,"-q:v","5","-y",h],{windowsHide:!0,stdio:"ignore"}),S=setTimeout(()=>{w.kill("SIGKILL"),g(new Error("FFmpeg timeout"))},1e4);w.on("close",d=>{clearTimeout(S),d===0?p():g(new Error(`FFmpeg exited with code ${d}`))}),w.on("error",d=>{clearTimeout(S),g(d)})}),!await s.pathExists(h))throw new Error("FFmpeg did not create thumbnail");const f=await b(h).webp({quality:r,effort:0}).toBuffer({resolveWithObject:!1});try{await s.unlink(h)}catch{}return await s.writeFile(u,f),`data:image/webp;base64,${f.toString("base64")}`}catch(t){return console.error("Failed to generate video thumbnail:",t),null}}async function Q(){if(!b)try{b=(await import("sharp")).default}catch(a){return console.error("Failed to load sharp:",a),!1}if(!x)try{x=(await import("fluent-ffmpeg")).default,await K("ffmpeg -version")}catch(a){return console.error("Failed to initialize ffmpeg:",a),!1}return!0}async function k(a,e={}){const t=c.extname(a).toLowerCase();if(!F.has(t)&&!q.has(t)||!await Q())return null;try{return await A.add(a,e)}catch(i){return console.error("Failed to generate thumbnail:",i),null}}exports.getThumbnail=k;
