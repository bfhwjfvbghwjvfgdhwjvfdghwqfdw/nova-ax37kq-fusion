"use strict";var S=Object.create;var d=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var x=(e,a,t,n)=>{if(a&&typeof a=="object"||typeof a=="function")for(let r of v(a))!q.call(e,r)&&r!==t&&d(e,r,{get:()=>a[r],enumerable:!(n=_(a,r))||n.enumerable});return e};var f=(e,a,t)=>(t=e!=null?S(F(e)):{},x(a||!e||!e.__esModule?d(t,"default",{value:e,enumerable:!0}):t,e));Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const i=require("fs-extra"),s=require("path"),E=require("child_process"),T=require("util");let g,b;const j=T.promisify(E.exec),p=s.join(process.env.APPDATA||process.env.HOME||".",".xvser-cache");i.ensureDirSync(p);const $=new Set([".mp4",".mkv",".avi",".mov",".wmv",".flv",".webm"]),y=new Set([".jpg",".jpeg",".png",".gif",".bmp",".webp"]);async function M(e,a={}){try{const{width:t=256,height:n=256,quality:r=80}=a,l=`img_${t}x${n}_${r}_${e.replace(/[^a-z0-9]/gi,"_")}`,u=s.join(p,l+".webp");try{const[o,m]=await Promise.all([i.stat(u),i.stat(e)]);if(o.mtimeMs>m.mtimeMs)return`data:image/webp;base64,${(await i.readFile(u)).toString("base64")}`}catch{}const c=await g(e).resize(t,n,{fit:"contain",background:{r:0,g:0,b:0,alpha:0}}).webp({quality:r}).toBuffer();return await i.writeFile(u,c),`data:image/webp;base64,${c.toString("base64")}`}catch(t){return console.error("Failed to generate image thumbnail:",t),null}}async function A(e,a={}){try{const{width:t=256,height:n=256,quality:r=80,timestamp:l="00:00:01"}=a,u=`vid_${t}x${n}_${r}_${l}_${e.replace(/[^a-z0-9]/gi,"_")}`,c=s.join(p,u+".webp");try{const[h,w]=await Promise.all([i.stat(c),i.stat(e)]);if(h.mtimeMs>w.mtimeMs)return`data:image/webp;base64,${(await i.readFile(c)).toString("base64")}`}catch{}const o=s.join(p,`temp_${Date.now()}.png`);await new Promise((h,w)=>{b(e).on("end",h).on("error",w).screenshots({timestamps:[l],filename:s.basename(o),folder:s.dirname(o),size:`${t}x${n}`})});const m=await g(o).webp({quality:r}).toBuffer();return await i.unlink(o),await i.writeFile(c,m),`data:image/webp;base64,${m.toString("base64")}`}catch(t){return console.error("Failed to generate video thumbnail:",t),null}}async function D(){if(!g)try{g=(await import("sharp")).default}catch(e){return console.error("Failed to load sharp:",e),!1}if(!b)try{b=(await import("fluent-ffmpeg")).default,await j("ffmpeg -version")}catch(e){return console.error("Failed to initialize ffmpeg:",e),!1}return!0}async function I(e,a={}){const t=s.extname(e).toLowerCase();if(!y.has(t)&&!$.has(t)||!await D())return null;try{if(y.has(t))return M(e,a);if($.has(t))return A(e,a)}catch(n){console.error("Failed to generate thumbnail:",n)}return null}exports.getThumbnail=I;
